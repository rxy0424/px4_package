name: Package Micro-XRCE-DDS-Agent (Full Source, Reproducible)

on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git ref to checkout (tag / branch / commit)'
        required: true
        default: 'master'

jobs:
  package:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Micro-XRCE-DDS-Agent with full history
        uses: actions/checkout@v4
        with:
          repository: eProsima/Micro-XRCE-DDS-Agent
          ref: ${{ github.event.inputs.ref }}
          fetch-depth: 0          # ðŸ”´ å®Œæ•´åŽ†å²
          submodules: recursive

      - name: Collect repository metadata
        run: |
          set -e

          echo "Micro-XRCE-DDS-Agent Source Package Metadata" > XRCE_AGENT_PACKAGE_INFO.txt
          echo "===========================================" >> XRCE_AGENT_PACKAGE_INFO.txt
          echo "" >> XRCE_AGENT_PACKAGE_INFO.txt

          echo "Repository: eProsima/Micro-XRCE-DDS-Agent" >> XRCE_AGENT_PACKAGE_INFO.txt
          echo "Ref: ${{ github.event.inputs.ref }}" >> XRCE_AGENT_PACKAGE_INFO.txt
          echo "" >> XRCE_AGENT_PACKAGE_INFO.txt

          echo "Commit:" >> XRCE_AGENT_PACKAGE_INFO.txt
          git rev-parse HEAD >> XRCE_AGENT_PACKAGE_INFO.txt
          echo "" >> XRCE_AGENT_PACKAGE_INFO.txt

          echo "Describe:" >> XRCE_AGENT_PACKAGE_INFO.txt
          git describe --tags --dirty --always >> XRCE_AGENT_PACKAGE_INFO.txt || true
          echo "" >> XRCE_AGENT_PACKAGE_INFO.txt

          echo "Build date (UTC):" >> XRCE_AGENT_PACKAGE_INFO.txt
          date -u +"%Y-%m-%d %H:%M:%S UTC" >> XRCE_AGENT_PACKAGE_INFO.txt
          echo "" >> XRCE_AGENT_PACKAGE_INFO.txt

          echo "Submodules:" >> XRCE_AGENT_PACKAGE_INFO.txt
          git submodule status --recursive >> XRCE_AGENT_PACKAGE_INFO.txt || echo "(none)" >> XRCE_AGENT_PACKAGE_INFO.txt

      - name: Create README for archive
        run: |
          cat > README_PACKAGE.md << 'EOF'
          # Micro-XRCE-DDS-Agent Full Source Package

          This archive contains the complete source tree of
          **eProsima Micro-XRCE-DDS-Agent** with:

          - Full git history
          - All submodules (recursively initialized)
          - Original directory structure preserved
          - `.git` directory included

          ## Intended usage

          - Offline development
          - PX4 / ROS 2 / DDS reproducible builds
          - Academic and industrial archiving
          - Traceability and long-term maintenance

          ## Notes

          - The source state corresponds exactly to the selected git ref.
          - Integrity can be verified using the provided SHA256 checksum.
          - The archive is generated in a reproducible manner.

          EOF

      - name: Create reproducible archive
        run: |
          set -e

          ARCHIVE_NAME="micro-xrce-dds-agent-full-source-${{ github.event.inputs.ref }}.tar.gz"

          # æ‰“åŒ…åˆ° /tmpï¼Œé¿å… tar è‡ªåŒ…å«
          tar \
            --sort=name \
            --owner=0 --group=0 --numeric-owner \
            --mtime="UTC 2024-01-01" \
            -czf "/tmp/${ARCHIVE_NAME}" \
            README_PACKAGE.md \
            XRCE_AGENT_PACKAGE_INFO.txt \
            .

          mv "/tmp/${ARCHIVE_NAME}" .

          sha256sum "${ARCHIVE_NAME}" > "${ARCHIVE_NAME}.sha256"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: micro-xrce-dds-agent-full-source-${{ github.event.inputs.ref }}
          path: |
            micro-xrce-dds-agent-full-source-${{ github.event.inputs.ref }}.tar.gz
            micro-xrce-dds-agent-full-source-${{ github.event.inputs.ref }}.tar.gz.sha256
