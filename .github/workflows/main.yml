name: Package PX4 (Full Source, Reproducible)

on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git ref to checkout (tag / branch / commit)'
        required: true
        default: 'v1.16.0'

jobs:
  package:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PX4 with full history and submodules
        uses: actions/checkout@v4
        with:
          repository: PX4/PX4-Autopilot
          ref: ${{ github.event.inputs.ref }}
          fetch-depth: 0              # ðŸ”´ å®Œæ•´åŽ†å²
          submodules: recursive

      - name: Collect repository metadata
        run: |
          set -e

          echo "PX4 Source Package Metadata" > PX4_PACKAGE_INFO.txt
          echo "============================" >> PX4_PACKAGE_INFO.txt
          echo "" >> PX4_PACKAGE_INFO.txt

          echo "Ref: ${{ github.event.inputs.ref }}" >> PX4_PACKAGE_INFO.txt
          echo "Commit:" >> PX4_PACKAGE_INFO.txt
          git rev-parse HEAD >> PX4_PACKAGE_INFO.txt
          echo "" >> PX4_PACKAGE_INFO.txt

          echo "Describe:" >> PX4_PACKAGE_INFO.txt
          git describe --tags --dirty --always >> PX4_PACKAGE_INFO.txt || true
          echo "" >> PX4_PACKAGE_INFO.txt

          echo "Build date (UTC):" >> PX4_PACKAGE_INFO.txt
          date -u +"%Y-%m-%d %H:%M:%S UTC" >> PX4_PACKAGE_INFO.txt
          echo "" >> PX4_PACKAGE_INFO.txt

          echo "Submodules:" >> PX4_PACKAGE_INFO.txt
          git submodule status --recursive >> PX4_PACKAGE_INFO.txt

      - name: Create README for archive
        run: |
          cat > README_PACKAGE.md << 'EOF'
          # PX4 Full Source Package

          This archive contains the full PX4-Autopilot source tree with:

          - Complete git history
          - All submodules (recursively initialized)
          - Original directory structure preserved

          ## Intended usage

          - Offline development
          - Reproducible research
          - Academic or industrial archiving
          - Code review and traceability

          ## Notes

          - The `.git` directory is preserved.
          - Submodule commits are fixed to the versions referenced
            by the selected PX4 ref.
          - Integrity can be verified using the provided SHA256 checksum.

          EOF

      - name: Create reproducible archive
        run: |
          set -e

          ARCHIVE_NAME="px4-full-source-${{ github.event.inputs.ref }}.tar.gz"

          # æ‰“åŒ…åˆ° /tmpï¼Œé¿å…è‡ªåŒ…å«
          tar \
            --sort=name \
            --owner=0 --group=0 --numeric-owner \
            --mtime="UTC 2024-01-01" \
            -czf "/tmp/${ARCHIVE_NAME}" \
            README_PACKAGE.md \
            PX4_PACKAGE_INFO.txt \
            .

          mv "/tmp/${ARCHIVE_NAME}" .

          sha256sum "${ARCHIVE_NAME}" > "${ARCHIVE_NAME}.sha256"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: px4-full-source-${{ github.event.inputs.ref }}
          path: |
            px4-full-source-${{ github.event.inputs.ref }}.tar.gz
            px4-full-source-${{ github.event.inputs.ref }}.tar.gz.sha256
